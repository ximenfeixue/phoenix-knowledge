<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="tb_category">
	<typeAlias alias="category" type="com.ginkgocap.ywxt.knowledge.model.Category"/>
	<resultMap class="com.ginkgocap.ywxt.knowledge.model.Category" id="categoryMap">
		<result column="id" property="id" jdbcType="BIGINT"/>
		<result column="uid" property="uid" jdbcType="BIGINT"/>
		<result column="categoryName" property="categoryName" jdbcType="VARCHAR"/>
		<result column="parentId" property="parentId" jdbcType="BIGINT"/>
		<result column="sortId" property="sortId" jdbcType="VARCHAR"/>
		<result column="state" property="state" jdbcType="VARCHAR"/>
		<result column="subtime" property="subtime" jdbcType="TIMESTAMP"/>
		<result column="modtime" property="modtime" jdbcType="TIMESTAMP"/>
	</resultMap>
	
	<sql id="dyColumns">id,uid,categoryName,parentId,sortId,subtime,modtime,state</sql>
	
	
	
	<!-- 通过主键找到分类记录 -->
	<select id="selectByPrimaryKey" resultMap="categoryMap" parameterClass="long">
		select <include refid="dyColumns"/> from tb_category where id= #value# 
	</select>
	<!-- 通过phoenix_user.tb_user.id得到此用户下经过树形结构排序的所有分类 -->
	<select id="selectTreeOfSortByUserid" resultMap="categoryMap" parameterClass="java.util.Map">
		select <include refid="dyColumns"/> from tb_category where uid= #uid:BIGINT#
		<dynamic>
			<isNotNull  prepend="AND" property="state">
				state = #state#
			</isNotNull >  
		</dynamic>
		order by sortId
	</select>
	<!-- 通过主键ID删除分类记录  -->
	<delete id="delete" parameterClass="long">
		delete from tb_category where id=#id:BIGINT#
	</delete>
	<!-- 存入分类记录 -->
	<insert id="insert" parameterClass="category">
		insert into tb_category(
			uid,categoryName,parentId,sortId,subtime,modtime,state
		) values (
			#uid:BIGINT#,
			#categoryName:VARCHAR#,
			#parentId:BIGINT#,
			#sortId:VARCHAR#,
			#subtime:TIMESTAMP#,
			#modtime:TIMESTAMP#,
			#state:VARCHAR#
		)
		<selectKey resultClass="long" type="post" keyProperty="id" > 
		SELECT LAST_INSERT_ID() AS VALUE     
		</selectKey>
	</insert>
	<!-- 修改分类 -->
	<update id="update" parameterClass="category">  
        UPDATE tb_category SET  
	        uid = #uid:BIGINT#,
			categoryName = #categoryName:VARCHAR#,
			parentId = #parentId:BIGINT#,
			sortId = #sortId:VARCHAR#,
			subtime = #subtime:TIMESTAMP#,
			modtime = #modtime:TIMESTAMP#,
			state = #state:VARCHAR#
        WHERE   
        	id = #id:BIGINT#   
    </update>

	<!-- 通过sortId得到此用户的分类  -->
	<select id="selectBySortId" resultMap="categoryMap" parameterClass="java.util.Map">
		select <include refid="dyColumns"/> from tb_category where uid = #uid# and sortId = #sortId# 
	</select>
	
	<!-- 通过sortId得到此用户的分类下所有的子分类  -->
	<select id="selectChildBySortId" resultMap="categoryMap" parameterClass="java.util.Map">
		select <include refid="dyColumns"/> from tb_category where uid = #uid# and sortId like CONCAT(#sortId#, '%') order by sortId
	</select>	
	
	<!-- 通过ID得到子分类的数量 -->
	<select id="selectChildCountById" resultClass="long" parameterClass="long">
		select count(id) from tb_category where parentId = #id#
	</select>
	
	<!-- 通过父类的sortId得到某用户下的分类最大的sortId -->
	<select id="selectMaxSortId" resultClass="string" parameterClass="java.util.Map">
		select max(sortid) from tb_category where uid=#uid# and sortId like #parentSortId#
	</select>
</sqlMap>