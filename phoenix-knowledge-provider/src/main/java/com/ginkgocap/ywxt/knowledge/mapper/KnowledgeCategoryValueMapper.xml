<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.ginkgocap.ywxt.knowledge.mapper.KnowledgeCategoryValueMapper" >
 
 
 <insert id="batchInsert" parameterType="java.util.List">
 
 insert into tb_knowledge_category (
			knowledge_id,
			category_id,
			status
			
		) values 
		 	<foreach collection="list" item="item" index="index" separator="," >  
        (#{item.knowledgeId},
				 #{item.categoryId},
				 #{item.status}
				 )  
    </foreach>  
 </insert>
 <select id="selectKnowledgeIds" resultType="map" >
	SELECT b.*,
	CASE
	        WHEN b.user_id=#{userId} THEN 'me'
	        ELSE 'other'
	END source, GROUP_CONCAT(uc.categoryName) `group`
	FROM tb_knowledge_category kc,
	tb_user_category
	uc,tb_knowledge_base b
	WHERE kc.category_id = uc.id
	AND b.knowledge_id=kc.knowledge_id
	AND kc.status=1
	AND uc.category_type = 0
	AND uc.user_id=#{userId}
	<if test="sortId !=null and sortId != ''">
	AND uc.sortid =#{sortId}
	</if>
	<if test="tid !=null and tid!=''">
		AND b.column_type=#{tid}
	</if>
	<if test="lid == 0 ">
		AND b.user_id=#{userId}
	</if>
	<if test="lid == 1 ">
		AND b.user_id!=#{userId}
	</if>
	<if test="keyword !=null and keyword != '' ">
		AND b.title like CONCAT('%',#{keyword},'%')
	</if>
	GROUP BY b.knowledge_id,b.user_id,b.title,b.author,b.path,b.createtime,b.tag,b.c_desc,b.column_id,b.pic_path,b.column_type,b.essence,b.taskid
	ORDER BY b.createtime DESC
	LIMIT #{start},#{size}
</select>
 <select id="countKnowledgeIds" resultType="int" >
 		select count(1) from (
			SELECT DISTINCT b.*
			FROM tb_knowledge_category kc,
			tb_user_category
			uc,tb_knowledge_base b
			WHERE kc.category_id = uc.id
			AND b.knowledge_id=kc.knowledge_id
			AND kc.status=1
			AND uc.category_type = 0
			AND uc.user_id=#{userId}
			<if test="sortId !=null and sortId != ''">
				AND uc.sortid =#{sortId}
			</if>
			<if test="tid !=null and tid!=''">
				AND b.column_type=#{tid}
			</if>
			<if test="lid == 0 ">
				AND b.user_id=#{userId}
			</if>
			<if test="lid == 1 ">
				AND b.user_id!=#{userId}
			</if>
			<if test="keyword !=null and keyword != '' ">
				AND b.title like CONCAT('%',#{keyword},'%')
			</if>
		)j
</select>
 <select id="selectKnowledgeId" resultType="map" >
	SELECT DISTINCT b.*
	FROM tb_knowledge_category kc,
	tb_user_category
	uc,tb_knowledge_base b LEFT JOIN tb_attachment a ON b.taskid=a.taskId
	WHERE kc.category_id = uc.id
	AND b.knowledge_id=kc.knowledge_id
	AND kc.status=1
	AND uc.category_type = 0
	AND uc.user_id=#{userId}
	AND uc.id in
	 <foreach item="groupid" collection="groupid" open="(" separator="," close=")">
  		#{groupid}
   	</foreach>
	ORDER BY b.createtime DESC
	LIMIT #{start},#{size}
</select>
 
 <select id="countKnowledgeId" resultType="int" >
 		select count(1) from (
			SELECT DISTINCT b.*
				FROM tb_knowledge_category kc,
				tb_user_category
				uc,tb_knowledge_base b LEFT JOIN tb_attachment a ON b.taskid=a.taskId
				WHERE kc.category_id = uc.id
				AND b.knowledge_id=kc.knowledge_id
				AND kc.status=1
				AND uc.category_type = 0
				AND uc.user_id=#{userId}
				AND uc.id in
				 <foreach item="groupid" collection="groupid" open="(" separator="," close=")">
			  		#{groupid}
			   	</foreach>
		)j
</select>

 <delete id="deleteKnowledge">
  delete from tb_knowledge_category 
     where  category_id=#{categoryid} 
     and  knowledge_id in 
     <foreach item="knowledgeids" collection="knowledgeids" open="(" separator="," close=")">
     #{knowledgeids}
 	</foreach>
 </delete>
</mapper>
