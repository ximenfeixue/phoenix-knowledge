<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="tb_article">
	<typeAlias alias="article" type="com.ginkgocap.ywxt.knowledge.model.Article"/>
	<resultMap class="com.ginkgocap.ywxt.knowledge.model.Article" id="articleMap">
		<result column="id" property="id" jdbcType="BIGINT"/>
		<result column="uid" property="uid" jdbcType="BIGINT"/>
		<result column="author" property="author" jdbcType="VARCHAR"/>
		<result column="source" property="source" jdbcType="VARCHAR"/>
		<result column="articleTitle" property="articleTitle" jdbcType="VARCHAR"/>
		<result column="articleType" property="articleType" jdbcType="VARCHAR"/>
		<result column="articleContent" property="articleContent" jdbcType="VARCHAR"/>
		<result column="categoryid" property="categoryid" jdbcType="BIGINT"/>
		<result column="sortId" property="sortId" jdbcType="VARCHAR"/>
		<result column="pubdate" property="pubdate" jdbcType="TIMESTAMP"/>
		<result column="modifyTime" property="modifyTime" jdbcType="TIMESTAMP"/>
		<result column="essence" property="essence" jdbcType="VARCHAR"/>
		<result column="recycleBin" property="recycleBin" jdbcType="VARCHAR"/>
		<result column="state" property="state" jdbcType="VARCHAR"/>
		<result column="clickNum" property="clickNum" jdbcType="BIGINT"/>
		<result column="task_id" property="taskId" jdbcType="VARCHAR"/>
	</resultMap>
	<resultMap class="com.ginkgocap.ywxt.knowledge.model.Article" id="articleCategoryMap">
		<result column="id" property="id" jdbcType="BIGINT"/>
		<result column="uid" property="uid" jdbcType="BIGINT"/>
		<result column="author" property="author" jdbcType="VARCHAR"/>
		<result column="source" property="source" jdbcType="VARCHAR"/>
		<result column="articleTitle" property="articleTitle" jdbcType="VARCHAR"/>
		<result column="articleType" property="articleType" jdbcType="VARCHAR"/>
		<result column="categoryid" property="categoryid" jdbcType="BIGINT"/>
		<result column="articleContent" property="articleContent" jdbcType="VARCHAR"/>
		<result column="sortId" property="sortId" jdbcType="VARCHAR"/>
		<result column="name" property="name" jdbcType="VARCHAR"/>
		<result column="pubdate" property="pubdate" jdbcType="TIMESTAMP"/>
		<result column="modifyTime" property="modifyTime" jdbcType="TIMESTAMP"/>
		<result column="essence" property="essence" jdbcType="VARCHAR"/>
		<result column="recycleBin" property="recycleBin" jdbcType="VARCHAR"/>
		<result column="state" property="state" jdbcType="VARCHAR"/>
		<result column="clickNum" property="clickNum" jdbcType="BIGINT"/>
		<result column="task_id" property="taskId" jdbcType="VARCHAR"/>
		<result column="isNew" property="isNew" jdbcType="VARCHAR"/>
	</resultMap>
	
	<sql id="allColumns">id,uid,author,source,articleTitle,articleType,articleContent,categoryid,sortId,pubdate,modifyTime,essence,recycleBin,state,clickNum,task_id</sql>
	<sql id="dyColumns">id,uid,author,source,articleTitle,articleType,categoryid,sortId,pubdate,modifyTime,essence,recycleBin,state,clickNum,task_id</sql>
	
	<select id="selectListCount" resultClass="long" parameterClass="java.util.Map">
		select count(a.id) from tb_article a left OUTER join tb_category b on a.categoryid = b.id where 1=1
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="uid">
				a.uid = #uid#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="AND" open="(" close=")">
			<isNotNull  prepend="OR" property="keywords">
				a.articleTitle like CONCAT('%',#keywords#,'%')
			</isNotNull>
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="articleType">
				a.articleType = #articleType:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="recycleBin">
				a.recycleBin = #recycleBin:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="essence">
				a.essence = #essence:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="sortId">
				a.sortId like CONCAT (#sortId:VARCHAR#,'%')
			</isNotNull>  
		</dynamic>
	</select>
	<select id="relationList" resultMap="articleCategoryMap" parameterClass="java.util.Map">
		select a.id,a.uid,a.author,a.source,a.articleTitle,a.articleType,a.categoryid,a.articleContent,a.sortId,
		b.name,a.pubdate,a.modifyTime,a.essence,a.recycleBin,a.state,
		a.clickNum,a.task_id,(a.pubdate - NOW() >= -(50000 * 60) OR a.modifyTime - NOW() >= -(50000 * 60)) as isNew 
		from tb_article a left OUTER join tb_category b on a.categoryid = b.id where 1=1 and a.recycleBin = '0'
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="uid">
				a.uid = #uid#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="relationid">
				a.id != #relationid:BIGINT#
			</isNotNull>  
		</dynamic>
     	order by $sort$ desc limit #start#,#size#
	</select>
	<select id="selectList" resultMap="articleCategoryMap" parameterClass="java.util.Map">
		select a.id,a.uid,a.author,a.source,a.articleTitle,a.articleType,a.categoryid,a.articleContent,a.sortId,
		b.name,a.pubdate,a.modifyTime,a.essence,a.recycleBin,a.state,
		a.clickNum,a.task_id,(a.pubdate - NOW() >= -(50000 * 60) OR a.modifyTime - NOW() >= -(50000 * 60)) as isNew 
		from tb_article a left OUTER join tb_category b on a.categoryid = b.id where 1=1
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="uid">
				a.uid = #uid#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="AND" open="(" close=")">
			<isNotNull  prepend="OR" property="keywords">
				a.articleTitle like CONCAT('%',#keywords#,'%')
			</isNotNull>
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="articleType">
				a.articleType = #articleType:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="recycleBin">
				a.recycleBin = #recycleBin:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="essence">
				a.essence = #essence:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="sortId">
				a.sortId like CONCAT (#sortId:VARCHAR#,'%')
			</isNotNull>  
		</dynamic>
     	order by $sort$ desc limit #start#,#size#
	</select>
	
	<select id="selectByPrimaryKey" resultMap="articleMap" parameterClass="long">
		select <include refid="allColumns"/> from tb_article where id= #value# 
	</select>
	
	<select id="selectCountByCategoryId" resultClass="long" parameterClass="long">
		select count(id) from tb_article where categoryid = #categoryid#
	</select>
	
	<update id="update" parameterClass="article">  
        UPDATE tb_article SET  
			uid=#uid:BIGINT#,
			author=#author:VARCHAR#,
			source=#source:VARCHAR#,
			articleTitle=#articleTitle:VARCHAR#,
			articleContent=#articleContent:VARCHAR#,
			categoryid=#categoryid:BIGINT#,
			sortId=#sortId:VARCHAR#,
			pubdate=#pubdate:TIMESTAMP#,
			modifyTime=#modifyTime:TIMESTAMP#,
			essence=#essence:VARCHAR#,
			recycleBin=#recycleBin:VARCHAR#,
			state=#state:VARCHAR#,
			clickNum=#clickNum:BIGINT#
        WHERE   
        	id=#id:BIGINT#   
    </update>
	
	
	<insert id="insert" parameterClass="article">
		insert into tb_article(
			uid,author,source,articleTitle,articleType,articleContent,categoryid,sortId,pubdate,modifyTime,essence,recycleBin,state,clickNum,task_id
		) values (
			#uid:BIGINT#,
			#author:VARCHAR#,
			#source:VARCHAR#,
			#articleTitle:VARCHAR#,
			#articleType:VARCHAR#,
			#articleContent:VARCHAR#,
			#categoryid:BIGINT#,
			#sortId:VARCHAR#,
			#pubdate:TIMESTAMP#,
			#modifyTime:TIMESTAMP#,
			#essence:VARCHAR#,
			#recycleBin:VARCHAR#,
			#state:VARCHAR#,
			#clickNum:BIGINT#,
			#taskId:VARCHAR#
		)
		<selectKey resultClass="long" type="post" keyProperty="id" > 
		SELECT LAST_INSERT_ID() AS VALUE     
		</selectKey>
	</insert>
    
    <select id="selectByParams" resultMap="articleCategoryMap" parameterClass="java.util.Map">
		select a.id,a.uid,a.author,a.source,a.articleTitle,a.articleType,a.categoryid,a.articleContent,a.sortId,
		b.name,a.pubdate,a.modifyTime,a.essence,a.recycleBin,a.state,
		a.clickNum,a.task_id,(a.pubdate - NOW() >= -(50000 * 60) OR a.modifyTime - NOW() >= -(50000 * 60)) as isNew 
		from tb_article a left OUTER join tb_category b on a.categoryid = b.id where 1=1 and a.recycleBin = '0'
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="uid">
				a.uid = #uid#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="AND" open="(" close=")">
			<isNotNull  prepend="OR" property="keywords">
				a.articleTitle like CONCAT('%',#keywords#,'%')
			</isNotNull>
		</dynamic>
     	order by a.id desc limit #start#,#size#
	</select>
	<select id="selectCountByParams" resultClass="long" parameterClass="java.util.Map">
		select count(a.id) from tb_article a left OUTER join tb_category b on a.categoryid = b.id where 1=1  and a.recycleBin = '0'
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="uid">
				a.uid = #uid#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="AND" open="(" close=")">
			<isNotNull  prepend="OR" property="keywords">
				a.articleTitle like CONCAT('%',#keywords#,'%')
			</isNotNull>
		</dynamic>
	</select>
	<update id="updateEssence" parameterClass="java.util.Map">  
        UPDATE tb_article SET 
			essence=#essence#
        WHERE id IN
        <iterate property="ids" open="(" close=")" conjunction=",">#ids[]#</iterate>
    </update>
	<update id="updateRecycleBin" parameterClass="java.util.Map">  
        UPDATE tb_article SET 
			recycleBin=#recycleBin#
        WHERE id IN
        <iterate property="ids" open="(" close=")" conjunction=",">#ids[]#</iterate>
    </update>
    <delete id="deleteArticles" parameterClass="java.util.Map">  
        DELETE from tb_article WHERE id IN
        <iterate property="ids" open="(" close=")" conjunction=",">#ids[]#</iterate>
    </delete>
    <select id="selectArticleList" resultMap="articleCategoryMap" parameterClass="java.util.Map">
    	select a.id,a.uid,a.author,a.source,a.articleTitle,a.articleType,a.categoryid,a.articleContent,a.sortId,
		b.name,a.pubdate,a.modifyTime,a.essence,a.recycleBin,a.state,
		a.clickNum,a.task_id,(a.pubdate - NOW() >= -(50000 * 60) OR a.modifyTime - NOW() >= -(50000 * 60)) as isNew 
		 from tb_article a left OUTER join tb_category b on a.categoryid = b.id where 1=1
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="uid">
				a.uid = #uid#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="recycleBin">
				a.recycleBin = #recycleBin:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="essence">
				a.essence = #essence:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="sortId">
				a.sortId like CONCAT (#sortId:VARCHAR#,'%')
			</isNotNull>  
		</dynamic>
     	order by a.id desc limit #start#,#size#
    </select>
    
    
    <select id="selectArticleListCount" resultClass="long" parameterClass="java.util.Map">
    	select count(a.id) from tb_article a left OUTER join tb_category b on a.categoryid = b.id where 1=1
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="uid">
				a.uid = #uid#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="recycleBin">
				a.recycleBin = #recycleBin:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="essence">
				a.essence = #essence:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="sortId">
				a.sortId like CONCAT (#sortId:VARCHAR#,'%')
			</isNotNull>  
		</dynamic>
    </select>
    <select id="articleAllListBySortId" resultMap="articleCategoryMap" parameterClass="java.util.Map">
        select a.id,a.uid,a.author,a.source,a.articleTitle,a.articleType,a.categoryid,a.articleContent,a.sortId,
		b.name,a.pubdate,a.modifyTime,a.essence,a.recycleBin,a.state,
		a.clickNum,a.task_id ,(a.pubdate - NOW() >= -(50000 * 60) OR a.modifyTime - NOW() >= -(50000 * 60)) as isNew 
		from tb_article a left OUTER join tb_category b on a.categoryid = b.id where 1=1
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="uid">
				a.uid = #uid#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="recycleBin">
				a.recycleBin = #recycleBin:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="essence">
				a.essence = #essence:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="sortId">
				a.sortId like CONCAT (#sortId:VARCHAR#,'%')
			</isNotNull>  
		</dynamic>
		order by a.sortId
    </select>
    <delete id="cleanRecyle" parameterClass="java.util.Map">
    	delete from tb_article where uid=#uid:BIGINT# and recycleBin='1'
    </delete>
    <select id="selectRecyleNum" resultClass="long" parameterClass="java.util.Map">
    	select count(*) from tb_article where recycleBin='1'
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="uid">
				uid = #uid#
			</isNotNull>  
		</dynamic>
    </select>
    <select id="checkArticleIsExist" resultClass="long" parameterClass="java.util.Map">
    	select count(*) from tb_article where articleContent = #url# and uid = #uid# and articleType='1'
		
    </select>
    
</sqlMap>
