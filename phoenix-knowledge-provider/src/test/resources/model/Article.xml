<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="tb_article">
	<typeAlias alias="article" type="com.ginkgocap.ywxt.knowledge.model.Article"/>
	<resultMap class="com.ginkgocap.ywxt.knowledge.model.Article" id="articleMap">
		<result column="id" property="id" jdbcType="BIGINT"/>
		<result column="uid" property="uid" jdbcType="BIGINT"/>
		<result column="author" property="author" jdbcType="VARCHAR"/>
		<result column="source" property="source" jdbcType="VARCHAR"/>
		<result column="articleTitle" property="articleTitle" jdbcType="VARCHAR"/>
		<result column="articleContent" property="articleContent" jdbcType="VARCHAR"/>
		<result column="categoryid" property="categoryid" jdbcType="BIGINT"/>
		<result column="sortId" property="sortId" jdbcType="VARCHAR"/>
		<result column="pubdate" property="pubdate" jdbcType="TIMESTAMP"/>
		<result column="modifyTime" property="modifyTime" jdbcType="TIMESTAMP"/>
		<result column="essence" property="essence" jdbcType="VARCHAR"/>
		<result column="recycleBin" property="recycleBin" jdbcType="VARCHAR"/>
		<result column="state" property="state" jdbcType="VARCHAR"/>
		<result column="clickNum" property="clickNum" jdbcType="BIGINT"/>
	</resultMap>
	<resultMap class="com.ginkgocap.ywxt.knowledge.model.Article" id="articleCategoryMap">
		<result column="id" property="id" jdbcType="BIGINT"/>
		<result column="uid" property="uid" jdbcType="BIGINT"/>
		<result column="author" property="author" jdbcType="VARCHAR"/>
		<result column="source" property="source" jdbcType="VARCHAR"/>
		<result column="articleTitle" property="articleTitle" jdbcType="VARCHAR"/>
		<result column="categoryid" property="categoryid" jdbcType="BIGINT"/>
		<result column="sortId" property="sortId" jdbcType="VARCHAR"/>
		<result column="categoryName" property="categoryName" jdbcType="VARCHAR"/>
		<result column="pubdate" property="pubdate" jdbcType="TIMESTAMP"/>
		<result column="modifyTime" property="modifyTime" jdbcType="TIMESTAMP"/>
		<result column="essence" property="essence" jdbcType="VARCHAR"/>
		<result column="recycleBin" property="recycleBin" jdbcType="VARCHAR"/>
		<result column="state" property="state" jdbcType="VARCHAR"/>
		<result column="clickNum" property="clickNum" jdbcType="BIGINT"/>
	</resultMap>
	
	<sql id="allColumns">id,uid,author,source,articleTitle,articleContent,categoryid,sortId,pubdate,modifyTime,essence,recycleBin,state,clickNum</sql>
	<sql id="dyColumns">id,uid,author,source,articleTitle,categoryid,sortId,pubdate,modifyTime,essence,recycleBin,state,clickNum</sql>
	<!-- 通过主键找到文章 -->
	<select id="selectByPrimaryKey" resultMap="articleMap" parameterClass="long">
		select <include refid="allColumns"/> from tb_article where id= #value# 
	</select>
	
	<!-- 通过Category.Id得到此分类下的文章数量 -->
	<select id="selectCountByCategoryId" resultClass="long" parameterClass="long">
		select count(id) from tb_article where categoryid = #categoryid#
	</select>
	
	<!-- 修改文章 -->
	<update id="update" parameterClass="article">  
        UPDATE tb_article SET  
			uid=#uid:BIGINT#,
			author=#author:VARCHAR#,
			source=#source:VARCHAR#,
			articleTitle=#articleTitle:VARCHAR#,
			articleContent=#articleContent:VARCHAR#,
			categoryid=#categoryid:BIGINT#,
			sortId=#sortId:VARCHAR#,
			pubdate=#pubdate:TIMESTAMP#,
			modifyTime=#modifyTime:TIMESTAMP#,
			essence=#essence:VARCHAR#,
			recycleBin=#recycleBin:VARCHAR#,
			state=#state:VARCHAR#,
			clickNum=#clickNum:BIGINT#
        WHERE   
        	id=#id:BIGINT#   
    </update>
	
	
	<!-- 存入文章 -->
	<insert id="insert" parameterClass="article">
		insert into tb_article(
			uid,author,source,articleTitle,articleContent,categoryid,sortId,pubdate,modifyTime,essence,recycleBin,state,clickNum
		) values (
			#uid:BIGINT#,
			#author:VARCHAR#,
			#source:VARCHAR#,
			#articleTitle:VARCHAR#,
			#articleContent:VARCHAR#,
			#categoryid:BIGINT#,
			#sortId:VARCHAR#,
			#pubdate:TIMESTAMP#,
			#modifyTime:TIMESTAMP#,
			#essence:VARCHAR#,
			#recycleBin:VARCHAR#,
			#state:VARCHAR#,
			#clickNum:BIGINT#
		)
		<selectKey resultClass="long" type="post" keyProperty="id" > 
		SELECT LAST_INSERT_ID() AS VALUE     
		</selectKey>
	</insert>
    
    <!-- 文章查询结果列表  -->
    <select id="selectByParams" resultMap="articleCategoryMap" parameterClass="java.util.Map">
		select a.id,a.uid,a.author,a.source,a.articleTitle,a.categoryid,a.sortId,
		b.categoryName,a.pubdate,a.modifyTime,a.essence,a.recycleBin,a.state,
		a.clickNum from tb_article a left OUTER join tb_category b on a.categoryid = b.id where 1=1
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="uid">
				a.uid = #uid#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="AND" open="(" close=")">
			<isNotNull  prepend="OR" property="keywords">
				a.articleTitle like CONCAT('%',#keywords#,'%')
			</isNotNull>
			<isNotNull  prepend="OR" property="keywords">
				a.articleContent like CONCAT('%', #keywords#, '%') 
			</isNotNull>
		</dynamic>
     	order by a.id desc limit #start#,#size#
	</select>
	<!-- 统计文章查询后的数量 -->
	<select id="selectCountByParams" resultClass="long" parameterClass="java.util.Map">
		select count(a.id) from tb_article a left OUTER join tb_category b on a.categoryid = b.id where 1=1
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="uid">
				a.uid = #uid#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="AND" open="(" close=")">
			<isNotNull  prepend="OR" property="keywords">
				a.articleTitle like CONCAT('%',#keywords#,'%')
			</isNotNull>
			<isNotNull  prepend="OR" property="keywords">
				a.articleContent like CONCAT('%', #keywords#, '%') 
			</isNotNull>
		</dynamic>
	</select>
	<!-- 批量更新文章是否加精状态 -->
	<update id="updateEssence" parameterClass="java.util.Map">  
        UPDATE tb_article SET 
			essence=#essence#
        WHERE id IN
        <iterate property="ids" open="(" close=")" conjunction=",">#ids[]#</iterate>
    </update>
    <!-- 批量删除(进入回收站)或恢复文章 -->
	<update id="updateRecycleBin" parameterClass="java.util.Map">  
        UPDATE tb_article SET 
			recycleBin=#recycleBin#
        WHERE id IN
        <iterate property="ids" open="(" close=")" conjunction=",">#ids[]#</iterate>
    </update>
    
    <!-- 取到文章列表 -->
    <select id="selectArticleList" resultMap="articleCategoryMap" parameterClass="java.util.Map">
    	select a.id,a.uid,a.author,a.source,a.articleTitle,a.categoryid,a.sortId,
		b.categoryName,a.pubdate,a.modifyTime,a.essence,a.recycleBin,a.state,
		a.clickNum from tb_article a left OUTER join tb_category b on a.categoryid = b.id where 1=1
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="uid">
				a.uid = #uid#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="recycleBin">
				a.recycleBin = #recycleBin:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="essence">
				a.essence = #essence:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="sortId">
				a.sortId like CONCAT (#sortId:VARCHAR#,'%')
			</isNotNull>  
		</dynamic>
     	order by a.id desc limit #start#,#size#
    </select>
    
    
    <select id="selectArticleListCount" resultClass="long" parameterClass="java.util.Map">
    	select count(a.id) from tb_article a left OUTER join tb_category b on a.categoryid = b.id where 1=1
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="uid">
				a.uid = #uid#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="recycleBin">
				a.recycleBin = #recycleBin:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="essence">
				a.essence = #essence:VARCHAR#
			</isNotNull>  
		</dynamic>
		<dynamic prepend="and">
			<isNotNull  prepend="AND" property="sortId">
				a.sortId like CONCAT (#sortId:VARCHAR#,'%')
			</isNotNull>  
		</dynamic>
    </select>    
</sqlMap>